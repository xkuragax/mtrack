# Руководство по развертыванию в облаке - Vercel + Railway + Neon

Полное руководство по развертыванию Multi-Track Audio Player в облаке с использованием 100% бесплатных сервисов.

## Архитектура

```
┌─────────────────┐     ┌──────────────────┐     ┌──────────────┐
│   Frontend      │     │   Admin Panel    │     │   Backend    │
│   (Vercel)      │────▶│   (Vercel)       │────▶│  (Railway)   │
│                 │     │                  │     │              │
│   React App     │     │   React App      │     │   Express    │
└─────────────────┘     └──────────────────┘     └──────┬───────┘
                                                        │
                                                        ▼
                                                 ┌──────────────┐
                                                 │ PostgreSQL   │
                                                 │   (Neon)     │
                                                 └──────────────┘
```

## Предварительные требования

1. Аккаунт GitHub с репозиторием проекта
2. Аккаунт Vercel (бесплатный)
3. Аккаунт Railway (бесплатный - $5 кредита в месяц)
4. Аккаунт Neon (бесплатный тариф)

---

## Шаг 1: Настройка PostgreSQL на Neon

### 1.1 Создание аккаунта Neon

1. Перейдите на [https://neon.tech](https://neon.tech)
2. Зарегистрируйтесь на бесплатный тариф
3. Создайте новый проект

### 1.2 Получение строки подключения

1. В дашборде Neon выберите ваш проект
2. Нажмите "Connection Details" (Детали подключения)
3. Скопируйте **Connection string** (выглядит так: `postgres://user:password@ep-xxx.us-east-2.aws.neon.tech/neondb...`)

**Сохраните эту строку подключения** - она понадобится для Railway.

---

## Шаг 2: Развертывание Backend на Railway

### 2.1 Создание аккаунта Railway

1. Перейдите на [https://railway.app](https://railway.app)
2. Зарегистрируйтесь (рекомендуется вход через GitHub)

### 2.2 Создание нового проекта

1. Нажмите "New Project" → "Deploy from GitHub repo"
2. Выберите ваш репозиторий mtrack
3. Нажмите "Deploy Now" (Развернуть сейчас)

### 2.3 Настройка переменных окружения

1. В проекте Railway перейдите во вкладку "Variables"
2. Добавьте следующие переменные окружения:

```env
PORT=3001
NODE_ENV=production
DATABASE_URL=<ваша-строка-подключения-neon>
JWT_SECRET=<сгенерируйте-случайную-строку>
CORS_ORIGIN=https://*.vercel.app
```

**Важно:**
- Замените `<ваша-строка-подключения-neon>` на строку из шага 1
- Сгенерируйте безопасный JWT_SECRET: `openssl rand -base64 32` или запустите `node scripts/generate-secrets.js`
- CORS_ORIGIN разрешает запросы с любых доменов Vercel

### 2.4 Инициализация базы данных

1. Нажмите на ваш backend сервис в Railway
2. Перейдите на вкладку "Logs" (Логи)
3. Нажмите вкладку "Console" (Консоль)
4. В консоли выполните:

```bash
cd backend
npm run init-db
```

Это создаст все таблицы и пользователя admin по умолчанию.

### 2.5 Получение URL Backend

1. В Railway перейдите к вашему backend сервису
2. Нажмите вкладку "Settings"
3. Скопируйте **Domain** (например, `https://your-app.railway.app`)

**Сохраните этот URL** - он понадобится для развертывания на Vercel.

---

## Шаг 3: Развертывание Frontend на Vercel

### 3.1 Создание аккаунта Vercel

1. Перейдите на [https://vercel.com](https://vercel.com)
2. Зарегистрируйтесь (рекомендуется вход через GitHub)

### 3.2 Импорт проекта для Frontend

1. Нажмите "Add New" → "Project"
2. Выберите ваш репозиторий mtrack
3. Установите **Root Directory** (Корневой каталог) в: `frontend`
4. Установите **Framework Preset** в: `Vite`
5. Нажмите "Deploy" (Развернуть)

### 3.3 Настройка переменных окружения

После развертывания:

1. Перейдите в ваш проект → Settings → Environment Variables
2. Добавьте следующую переменную:

```env
VITE_API_URL=https://ваш-railway-app.railway.app
```

Замените `ваш-railway-app.railway.app` на ваш фактический URL Railway из шага 2.5.

### 3.4 Переразвертывание

1. Перейдите на вкладку "Deployments" (Развертывания)
2. Нажмите на три точки на последнем развертывании → "Redeploy"
3. Это применит новую переменную окружения

### 3.5 Получение URL Frontend

После переразвертывания вы увидите URL вида:
`https://ваш-frontend-name.vercel.app`

---

## Шаг 4: Развертывание Admin Panel на Vercel

### 4.1 Создание нового проекта Vercel

1. Перейдите в Vercel → "Add New" → "Project"
2. Выберите тот же репозиторий mtrack
3. Установите **Root Directory** в: `admin`
4. Установите **Framework Preset** в: `Vite`
5. Установите **Project Name** в: `mtrack-admin` или подобное
6. Нажмите "Deploy"

### 4.2 Настройка переменных окружения

После развертывания:

1. Перейдите в проект → Settings → Environment Variables
2. Добавьте следующую переменную:

```env
VITE_API_URL=https://ваш-railway-app.railway.app
```

Используйте тот же URL Railway backend, как в шаге 3.3.

### 4.3 Переразвертывание

1. Перейдите на вкладку "Deployments"
2. Нажмите "Redeploy" на последнем развертывании

### 4.4 Получение URL Admin

Вы увидите URL вида:
`https://mtrack-admin.vercel.app`

---

## Шаг 5: Обновление CORS на Railway (если необходимо)

Если вы сначала развернули проекты на Vercel и получили конкретные URL:

1. Вернитесь в Railway → Backend сервис → Variables
2. Обновите `CORS_ORIGIN`, указав точные URL Vercel:

```env
CORS_ORIGIN=https://ваш-frontend.vercel.app,https://mtrack-admin.vercel.app
```

3. Railway автоматически переразвернет проект с новой конфигурацией.

---

## Шаг 6: Проверка развертывания

### 6.1 Проверка Backend API

Откройте в браузере или используйте curl:
```
https://ваш-railway-app.railway.app/health
```

Ожидаемый ответ:
```json
{
  "status": "OK",
  "message": "Server is running"
}
```

### 6.2 Проверка Frontend

1. Откройте: `https://ваш-frontend.vercel.app`
2. Должен загрузиться и показать альбомы (если вы их добавили)
3. Никаких ошибок в консоли браузера (DevTools)

### 6.3 Проверка Admin Panel

1. Откройте: `https://mtrack-admin.vercel.app`
2. Войдите с учетными данными по умолчанию:
   - Username: `admin`
   - Password: `admin123`
3. Попробуйте создать альбом или загрузить трек

---

## Шаг 7: Изменение пароля admin по умолчанию (Важно!)

### 7.1 Подключение к консоли Neon

1. Перейдите в [Neon Console](https://console.neon.tech)
2. Выберите ваш проект
3. Нажмите "SQL Editor" или "Console"

### 7.2 Выполнение запроса на обновление

```sql
UPDATE admin_users
SET password_hash = '$2a$10$ваш-новый-хешированный-пароль'
WHERE username = 'admin';
```

**Чтобы сгенерировать новый хеш пароля, выполните локально:**
```bash
node -e "const bcrypt = require('bcryptjs'); console.log(bcrypt.hashSync('ваш-новый-пароль', 10));"
```

Или используйте скрипт:
```bash
node scripts/generate-secrets.js
```

---

## Внесение изменений и обновлений

### Автоматические развертывания

Все развертывания теперь автоматические при push в ветку main:

1. **Изменения в backend:**
   - Внесите изменения в папку `backend/`
   - Закоммитьте и запушьте в GitHub
   - Railway автоматически переразвертывает

2. **Изменения во frontend:**
   - Внесите изменения в папку `frontend/`
   - Закоммитьте и запушьте в GitHub
   - Vercel автоматически переразвертывает

3. **Изменения в admin:**
   - Внесите изменения в папку `admin/`
   - Закоммитьте и запушьте в GitHub
   - Vercel автоматически переразвертывает

### Миграции базы данных

Если вы изменяете схему базы данных:

1. Обновите `backend/src/scripts/initDb.js`
2. В консоли Railway выполните:
   ```bash
   cd backend
   npm run init-db
   ```
3. Или используйте SQL Editor Neon для выполнения конкретных запросов миграции

---

## Справочник переменных окружения

### Backend (Railway)
```env
PORT=3001
NODE_ENV=production
DATABASE_URL=postgres://user:pass@host/db
JWT_SECRET=ваш-секретный-ключ
CORS_ORIGIN=https://*.vercel.app
```

### Frontend (Vercel)
```env
VITE_API_URL=https://ваш-api.railway.app
```

### Admin (Vercel)
```env
VITE_API_URL=https://ваш-api.railway.app
```

---

## Устранение неполадок

### Проблема: Ошибки CORS

**Решение:** Проверьте переменную CORS_ORIGIN в Railway - она должна включать ваши домены Vercel:
```
CORS_ORIGIN=https://ваш-frontend.vercel.app,https://ваш-admin.vercel.app
```

### Проблема: Не удалось подключиться к базе данных

**Решение:**
1. Проверьте, что DATABASE_URL правильный в Railway
2. Проверьте дашборд Neon - активна ли база данных?
3. Проверьте логи Railway для детальной информации об ошибке

### Проблема: API возвращает 404

**Решение:**
1. Проверьте VITE_API_URL в переменных окружения Vercel
2. Убедитесь, что backend на Railway развернут и работает
3. Протестируйте эндпоинт `/health` напрямую

### Проблема: Загрузка файлов не работает

**Текущее ограничение:**
- Загрузка файлов работает, но файлы хранятся в эфемерной файловой системе Railway
- Файлы теряются при переразвертывании Railway (обычно после неактивности)

**Решения для продакшена:**
1. Использовать постоянное хранилище (Railway Volume - платно)
2. Перейти на облачное хранилище (AWS S3, Cloudinary и т.д.)
3. Рассмотреть использование дисковой службы Railway для небольших проектов

### Проблема: Вход в админку не работает

**Решение:**
1. Убедитесь, что база данных инициализирована: `npm run init-db`
2. Проверьте логи Railway на наличие ошибок
3. Попробуйте сбросить пароль admin через SQL Editor Neon

---

## Лучшая практика безопасности

### 1. JWT Secret
- Используйте сильный, случайный JWT_SECRET (32+ символов)
- Сгенерируйте с помощью: `openssl rand -base64 32`
- Никогда не коммитьте секреты в GitHub

### 2. Database URL
- DATABASE_URL от Neon уже безопасен
- Не делитесь им публично
- Смените его, если он был скомпрометирован

### 3. CORS
- Будьте конкретны с CORS_ORIGIN в продакшене
- Не используйте `*` или слишком широкие шаблоны
- Ограничьте вашими точными доменами Vercel

### 4. Пароль Admin
- Смените пароль admin по умолчанию немедленно
- Используйте сильный пароль
- Рассмотрите двухфакторную аутентификацию для критичных приложений

---

## Стоимость и лимиты

### Лимиты бесплатного тарифа

**Vercel (Hobby):**
- Неограниченные развертывания
- 100ГБ трафика в месяц
- 6ГБ для сборки
- Нет тайм-аута сервера (только frontend)

**Railway (Бесплатно):**
- $5 кредита в месяц
- До 512МБ RAM
- До 1 CPU
- Эфемерное хранилище (теряется при переразвертывании)

**Neon (Бесплатно):**
- 0.5ГБ хранилища
- 100 часов вычислений в месяц
- 3 ветки

### Ориентировочная ежемесячная стоимость

Для небольшого проекта с умеренным трафиком:
- **Vercel:** $0 (план Hobby достаточен)
- **Railway:** $0-$10 (в зависимости от использования)
- **Neon:** $0 (бесплатный тариф покрывает большинство случаев использования)

---

## Мониторинг и логи

### Vercel
- Просмотр логов: Project → Deployments → Выберите развертывание → "View Function Logs"
- В реальном времени: Project → Deployments → "View Logs"

### Railway
- Просмотр логов: Project → Service → вкладка "Logs"
- Консоль в реальном времени: Project → Service → вкладка "Console"

### Neon
- Просмотр логов: Project → вкладка "Logs"
- SQL запросы: Project → "SQL Editor"

---

## Следующие шаги

### Рекомендуемые улучшения

1. **Добавление собственного домена**
   - Купите домен
   - Настройте в Vercel и Railway
   - Настройте SSL (автоматически на обеих платформах)

2. **Реализация постоянного хранилища**
   - Добавьте Railway Volume (~$5/месяц)
   - Или мигрируйте на S3/Cloudinary для загрузки файлов

3. **Добавление мониторинга**
   - Настройте отслеживание ошибок (Sentry)
   - Добавьте аналитику (Google Analytics)
   - Мониторинг доступности (UptimeRobot)

4. **Резервное копирование базы данных**
   - Включите автоматические бэкапы Neon
   - Экспортируйте бэкапы вручную регулярно

5. **Улучшения CI/CD**
   - Добавьте автоматические тесты
   - Развертывание по PR в preview окружения
   - Добавьте staging окружение

---

## Итоговые URL

После завершения этого руководства у вас должны быть:

- **Frontend:** `https://ваш-frontend.vercel.app`
- **Admin:** `https://ваш-admin.vercel.app`
- **Backend API:** `https://ваш-app.railway.app`
- **База данных:** Neon PostgreSQL console

Все три части обновляются автоматически при push в GitHub!

---

## Быстрая справка: Внесение обновлений

```bash
# 1. Внесите изменения в код
# Отредактируйте файлы в backend/, frontend/ или admin/

# 2. Закоммитьте изменения
git add .
git commit -m "Описание ваших изменений"

# 3. Запушьте в GitHub
git push origin main

# 4. Наблюдайте за развертываниями:
# - Railway: автоматически переразвертывает backend
# - Vercel: автоматически переразвертывает frontend и admin
```

Вот и всё! Никаких ручных шагов развертывания не требуется.
